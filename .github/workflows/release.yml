name: Release Build

on:
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      force_release:
        description: "Force official release even if version numbers did not change"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release aOS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-multilib \
          g++-multilib \
          nasm \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools

    - name: Extract version from version.h
      id: version
      run: |
        MAJOR=$(grep "AOS_VERSION_MAJOR" include/version.h | grep -oP '\d+')
        MINOR=$(grep "AOS_VERSION_MINOR" include/version.h | grep -oP '\d+')
        PATCH=$(grep "AOS_VERSION_PATCH" include/version.h | grep -oP '\d+')
        VERSION="${MAJOR}.${MINOR}.${PATCH}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

    - name: Check if version.h changed
      id: version_changed
      run: |
        if git diff ${{ github.event.before || 'HEAD~1' }} ${{ github.sha }} --name-only | \
           grep -q "^include/version.h$"; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Check if version numbers changed
      id: version_numbers_changed
      run: |
        if git diff ${{ github.event.before || 'HEAD~1' }} ${{ github.sha }} -U0 include/version.h | \
           grep -E '^\+.*AOS_VERSION_(MAJOR|MINOR|PATCH)'; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Enforce version bump discipline
      if: |
        github.event_name == 'push' &&
        steps.version_changed.outputs.changed == 'true' &&
        steps.version_numbers_changed.outputs.changed == 'false'
      run: |
        echo "include/version.h modified without version bump"
        exit 1

    - name: Generate build metadata
      id: metadata
      run: |
        echo "short_sha=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT
        echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

    - name: Build kernel
      run: make iso

    - name: Verify ISO creation
      run: test -f build/aOS.iso

    # Development build (always)
    - name: Rename ISO for development build
      run: |
        DEV_NAME="aOS-${{ steps.version.outputs.version }}-${{ steps.metadata.outputs.short_sha }}-${{ steps.metadata.outputs.date }}.iso"
        cp build/aOS.iso "build/${DEV_NAME}"

    - name: Upload development artifact
      uses: actions/upload-artifact@v4
      with:
        name: aOS-dev-${{ steps.version.outputs.version }}
        path: build/*.iso
        retention-days: 10

    - name: Check if release tag already exists
      id: tag_check
      run: |
        if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate changelog
      id: changelog
      run: |
        LAST_TAG=$(git tag --sort=-creatordate | head -n 1 || true)

        if [ -n "$LAST_TAG" ]; then
          RANGE="$LAST_TAG..HEAD"
        else
          RANGE="HEAD"
        fi

        echo "## Changes" > changelog.md
        git log $RANGE \
          --pretty=format:"- %s (%h)" \
          --no-merges >> changelog.md

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat changelog.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # Official release (silent force)
    - name: Rename ISO for stable release
      if: |
        (
          steps.version_numbers_changed.outputs.changed == 'true' ||
          github.event.inputs.force_release == 'true'
        ) &&
        steps.tag_check.outputs.exists == 'false'
      run: |
        cp build/aOS.iso "build/aOS-${{ steps.version.outputs.version }}-stable.iso"

    - name: Create GitHub Release
      if: |
        (
          steps.version_numbers_changed.outputs.changed == 'true' ||
          github.event.inputs.force_release == 'true'
        ) &&
        steps.tag_check.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: aOS v${{ steps.version.outputs.version }}
        body: |
          ## aOS v${{ steps.version.outputs.version }}

          ### Build Info
          - Version: `${{ steps.version.outputs.version }}`
          - Commit: `${{ steps.metadata.outputs.short_sha }}`
          - Build date: `${{ steps.metadata.outputs.date }}`

          ### Changelog
          ${{ steps.changelog.outputs.changelog }}

          ---
          Generated automatically by GitHub Actions.
        files: build/aOS-${{ steps.version.outputs.version }}-stable.iso
        fail_on_unmatched_files: true

    # Force info stays private (Actions UI only)
    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ steps.metadata.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Date: ${{ steps.metadata.outputs.date }}" >> $GITHUB_STEP_SUMMARY

        if [ "${{ github.event.inputs.force_release }}" == "true" ]; then
          echo "âš ï¸ Forced release (hidden from public release notes)" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.version_numbers_changed.outputs.changed }}" == "true" ]; then
          echo "ðŸš€ Stable release published" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ§ª Development build only" >> $GITHUB_STEP_SUMMARY
        fi
