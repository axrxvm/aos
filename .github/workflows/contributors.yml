name: Contributors Credits

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"
  push:
    branches: [ main ]
    paths-ignore:
      - CONTRIBUTORS.md

permissions:
  contents: write

jobs:
  update-contributors:
    name: Update CONTRIBUTORS.md
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate CONTRIBUTORS.md
      run: |
        {
          echo "# Contributors"
          echo ""
          echo "This file is generated automatically from the git history."
          echo ""
          echo "Last updated: $(date -u +'%Y-%m-%d') UTC."
          echo ""
          echo "| Contributor | Commits |"
          echo "| --- | ---: |"
          git shortlog -sne --all \
            | sed '/github-actions\[bot\]/d' \
            | sed '/dependabot\[bot\]/d' \
            | sed '/renovate\[bot\]/d' \
            | awk '{
                count=$1
                $1=""
                sub(/^ +/, "", $0)
                contributor=$0
                sub(/ <.*>$/, "", contributor)
                if (contributor != "") {
                  printf("| %s | %s |\n", contributor, count)
                }
              }'
        } > CONTRIBUTORS.md

    - name: Commit and push if changed
      run: |
        if git diff --quiet -- CONTRIBUTORS.md; then
          echo "No contributor updates."
          exit 0
        fi

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add CONTRIBUTORS.md
        git commit -m "docs: update contributors list"
        git push
