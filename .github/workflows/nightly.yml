name: Nightly Build

on:
  schedule:
    # Run every day at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  nightly-build:
    name: Nightly Build & Test (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [i386, x86_64]
    permissions:
      contents: read
      actions: write
    
    steps:
    - name: Checkout latest code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-multilib \
          g++-multilib \
          nasm \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools \
          qemu-system-x86
    
    - name: Build kernel (${{ matrix.arch }})
      run: make ARCH=${{ matrix.arch }} iso
    
    - name: Quick QEMU test (${{ matrix.arch }})
      timeout-minutes: 2
      run: |
        ISO_PATH="build/${{ matrix.arch }}/aOS.iso"
        SERIAL_LOG="serial-${{ matrix.arch }}.log"
        if [ "${{ matrix.arch }}" = "i386" ]; then
          QEMU_BIN="qemu-system-i386"
        else
          QEMU_BIN="qemu-system-x86_64"
        fi

        timeout 30s "$QEMU_BIN" \
          -cdrom "$ISO_PATH" \
          -serial "file:${SERIAL_LOG}" \
          -display none \
          -m 128M \
          || true
        
        if grep -a -q "aOS" "$SERIAL_LOG"; then
          echo "✓ Kernel booted successfully for ${{ matrix.arch }}"
          cat "$SERIAL_LOG"
        else
          echo "⚠️  Kernel boot verification incomplete for ${{ matrix.arch }}"
          cat "$SERIAL_LOG"
        fi
    
    - name: Generate build report (${{ matrix.arch }})
      run: |
        ISO_PATH="build/${{ matrix.arch }}/aOS.iso"
        SERIAL_LOG="serial-${{ matrix.arch }}.log"
        REPORT_PATH="build-report-${{ matrix.arch }}.txt"
        ISO_SIZE=$(stat -c%s "$ISO_PATH")
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        cat > "$REPORT_PATH" << EOF
        # aOS Nightly Build Report
        
        - Architecture: ${{ matrix.arch }}
        - Build Date: $BUILD_DATE
        - Commit: $COMMIT_HASH
        - ISO Size: $(numfmt --to=iec-i --suffix=B $ISO_SIZE)
        - Status: Success ✓
        
        ## Serial Output
        \`\`\`
        $(cat "$SERIAL_LOG")
        \`\`\`
        EOF
        
        cat "$REPORT_PATH"
    
    - name: Upload nightly build (${{ matrix.arch }})
      uses: actions/upload-artifact@v4
      with:
        name: aos-nightly-${{ matrix.arch }}-${{ github.run_number }}
        path: |
          build/${{ matrix.arch }}/aOS.iso
          serial-${{ matrix.arch }}.log
          build-report-${{ matrix.arch }}.txt
        retention-days: 7
    
    - name: Cleanup old artifacts
      if: matrix.arch == 'x86_64'
      uses: actions/github-script@v7
      with:
        script: |
          const repo = context.repo;
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: repo.owner,
            repo: repo.repo,
            per_page: 100
          });
          
          // Keep only last 7 nightly builds
          const nightlyArtifacts = artifacts.data.artifacts
            .filter(a => a.name.startsWith('aos-nightly-'))
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(7);
          
          for (const artifact of nightlyArtifacts) {
            console.log(`Deleting old artifact: ${artifact.name}`);
            await github.rest.actions.deleteArtifact({
              owner: repo.owner,
              repo: repo.repo,
              artifact_id: artifact.id
            });
          }
